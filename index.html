<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CPM Vinyl AI</title>

<style>
body {
  font-family: sans-serif;
  text-align: center;
  background: #f5f5f5;
  margin: 0;
  padding: 20px;
}
h1 { margin-bottom: 10px; }
.box {
  background: white;
  padding: 15px;
  margin: 10px auto;
  width: 95%;
  max-width: 400px;
  border-radius: 10px;
}
button {
  padding: 12px 20px;
  font-size: 16px;
}
.preview {
  position: relative;
  width: 90%;
  max-width: 360px;
  margin: 20px auto;
}
.preview img {
  width: 100%;
  border-radius: 8px;
}
.vinyl {
  position: absolute;
  width: 40%;
  opacity: 0.85;
}
</style>
</head>

<body>

<h1>CPM ãƒã‚¤ãƒŠãƒ«AIé…ç½®</h1>

<div class="box">
  <p>â‘  è»Šç”»åƒ</p>
  <input type="file" id="car" accept="image/*">
</div>

<div class="box">
  <p>â‘¡ ãƒã‚¤ãƒŠãƒ«ç”»åƒ</p>
  <input type="file" id="vinyl" accept="image/*">
</div>

<button id="run" disabled>AIè§£æé–‹å§‹</button>

<script>
const carInput = document.getElementById("car");
const vinylInput = document.getElementById("vinyl");
const runBtn = document.getElementById("run");

function checkReady() {
  runBtn.disabled = !(carInput.files.length && vinylInput.files.length);
}
carInput.onchange = checkReady;
vinylInput.onchange = checkReady;

// ğŸ”½ File â†’ Base64
function toBase64(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.readAsDataURL(file);
  });
}

runBtn.onclick = async () => {
  document.body.innerHTML = "<h2>ğŸ¤– AIè§£æä¸­â€¦</h2>";

  const carBase64 = await toBase64(carInput.files[0]);
  const vinylBase64 = await toBase64(vinylInput.files[0]);

  // ğŸ”´ ã“ã“ã ã‘å¤‰æ›´ï¼ï¼
  const GRADIO_URL = "https://75b35c0c9b40620160.gradio.live/";

  try {
    const res = await fetch(GRADIO_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        data: [carBase64, vinylBase64]
      })
    });

    const json = await res.json();
    const result = json.data[0].recommended[0];

    showResult(carBase64, vinylBase64, result.top, result.left);

  } catch (e) {
    document.body.innerHTML = "<h2>âŒ AIã‚µãƒ¼ãƒæ¥ç¶šå¤±æ•—</h2><button onclick='location.reload()'>æˆ»ã‚‹</button>";
  }
};

function showResult(carImg, vinylImg, top, left) {
  document.body.innerHTML = `
    <h1>AIé…ç½®çµæœ</h1>
    <div class="preview">
      <img src="${carImg}">
      <img src="${vinylImg}" class="vinyl"
        style="top:${top*100}%; left:${left*100}%;">
    </div>
    <p>AIãŒæœ€é©ãªä½ç½®ã‚’æ¨å®šã—ã¾ã—ãŸ</p>
    <button onclick="location.reload()">ã‚‚ã†ä¸€åº¦</button>
  `;
}
</script>

</body>
</html>
